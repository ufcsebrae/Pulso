<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Execução Orçamentária 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Não há mais configuração de tailwind duplicada aqui -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #F3F4F6; color: #1F2937; }
        .chart-container { position: relative; width: 100%; height: 350px; margin: auto; }
        .card { background-color: white; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); padding: 1.5rem; height: 100%; }
        .no-data-message { display: flex; align-items: center; justify-content: center; height: 100%; text-align: center; color: #6b7280; font-size: 0.875rem; }
    </style>
</head>
<body class="antialiased">
    <nav class="bg-white shadow-sm sticky top-0 z-50"><div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8"><div class="flex justify-between h-16"><div class="flex items-center"><span class="text-2xl font-bold text-brand-primary">Monitoramento Orçamentário 2025</span></div></div></div></nav>
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="mb-8 p-6 bg-white rounded-lg shadow-md"><h1 class="text-3xl font-bold text-gray-900 mb-4">Visão Geral da Execução: __UNIDADE_ALVO__</h1><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="bg-blue-50 p-4 rounded-lg border-l-4 border-project-exclusive"><h3 class="font-bold text-blue-800">Projetos Exclusivos</h3><p class="text-sm text-blue-700 mt-1">Projetos cujo orçamento pertence a uma <strong>única unidade</strong>.</p></div><div class="bg-green-50 p-4 rounded-lg border-l-4 border-project-shared"><h3 class="font-bold text-green-800">Projetos Compartilhados</h3><p class="text-sm text-green-700 mt-1">Projetos que envolvem <strong>duas ou mais unidades</strong>.</p></div></div></div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10"><div class="card border-l-4 border-brand-primary"><h3 class="text-sm font-medium text-gray-500 uppercase">Execução Total</h3><p class="text-3xl font-bold text-gray-900 mt-2">__KPI_TOTAL_PERC__</p><p class="mt-1 text-sm text-gray-500">__KPI_TOTAL_VALORES__</p></div><div class="card border-l-4 border-project-exclusive"><h3 class="text-sm font-medium text-gray-500 uppercase">Execução Proj. Exclusivos</h3><p class="text-3xl font-bold text-gray-900 mt-2">__KPI_EXCLUSIVO_PERC__</p><p class="mt-1 text-sm text-gray-500">__KPI_EXCLUSIVO_VALORES__</p></div><div class="card border-l-4 border-project-shared"><h3 class="text-sm font-medium text-gray-500 uppercase">Execução Proj. Compartilhados</h3><p class="text-3xl font-bold text-gray-900 mt-2">__KPI_COMPARTILHADO_PERC__</p><p class="mt-1 text-sm text-gray-500">__KPI_COMPARTILHADO_VALORES__</p></div></div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-10"><div class="lg:col-span-3"><div class="card"><h2 class="text-xl font-bold text-gray-800">Evolução Mensal: Executado</h2><p class="text-sm text-gray-500 mt-1 mb-6">Comparativo da execução por tipo de projeto.</p><div class="chart-container"><canvas id="trendChart"></canvas></div></div></div></div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10"><div class="card"><h2 class="text-xl font-bold text-gray-800 mb-2">Estrutura de Gastos (Proj. Exclusivos)</h2><p class="text-sm text-gray-500 mb-4">Proporção do valor executado por natureza.</p><div id="treemapExclusivo" class="chart-container"></div></div><div class="card"><h2 class="text-xl font-bold text-gray-800 mb-2">Estrutura de Gastos (Proj. Compartilhados)</h2><p class="text-sm text-gray-500 mb-4">Proporção do valor executado por natureza.</p><div id="treemapCompartilhado" class="chart-container"></div></div></div>
        <div class="grid grid-cols-1 gap-8 mb-10"><div class="card"><h2 class="text-xl font-bold text-gray-800 mb-2">Orçamento não utilizado por Projeto (Top 7)</h2><p class="text-sm text-gray-500 mb-4">Maiores saldos não executados.</p><div class="chart-container" style="height: 400px;" id="idleBudgetContainer"><canvas id="idleBudgetChart"></canvas></div></div></div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10"><div class="card"><h2 class="text-xl font-bold text-gray-800 mb-2">Execução Sem Planejamento (Exclusivos)</h2><p class="text-sm text-gray-500 mb-4">Gastos em naturezas onde o orçamento era zero.</p><div class="chart-container" id="unplannedExclusivoContainer"><canvas id="unplannedExclusivoChart"></canvas></div></div><div class="card"><h2 class="text-xl font-bold text-gray-800 mb-2">Execução Sem Planejamento (Compartilhados)</h2><p class="text-sm text-gray-500 mb-4">Gastos em naturezas onde o orçamento era zero.</p><div class="chart-container" id="unplannedCompartilhadoContainer"><canvas id="unplannedCompartilhadoChart"></canvas></div></div></div>
        <div class="grid grid-cols-1 gap-8 my-10"><div class="card"><h2 class="text-2xl font-bold text-gray-800 mb-2">Análise Detalhada de Projetos Exclusivos</h2><p class="text-sm text-gray-500 mb-6">As visualizações abaixo focam apenas nos projetos cuja gestão orçamentária é exclusiva da unidade.</p></div></div>
        <div class="grid grid-cols-1 gap-8 mb-10"><div class="card"><h2 class="text-xl font-bold text-gray-800 mb-2">Visão Hierárquica do Orçamento (Sunburst)</h2><p class="text-sm text-gray-500 mb-4">Distribuição do <strong>Valor Planejado</strong>. A cor indica o <strong>% de Execução</strong>.</p><div id="sunburstProjetos" class="chart-container" style="height: 500px;">__SUNBURST_PLACEHOLDER__</div></div></div>
        <div class="grid grid-cols-1 gap-8 mb-10"><div class="card"><h2 class="text-xl font-bold text-gray-800 mb-2">Mapa de Performance (Heatmap)</h2><p class="text-sm text-gray-500 mb-4">Performance de execução (%) entre Projetos e Naturezas.</p><div style="height: 600px; overflow: auto;"><div id="heatmapProjetos">__HEATMAP_PLACEHOLDER__</div></div></div></div>
        <div class="grid grid-cols-1 gap-8 mb-10"><div class="card"><h2 class="text-xl font-bold text-gray-800 mb-2">Gargalos de Execução (Inércia Máxima)</h2><p class="text-sm text-gray-500 mb-4">Maior tempo (em meses) para o primeiro gasto.</p><div id="inerciaBarChart" class="chart-container" style="height: 500px;">__INERCIA_PLACEHOLDER__</div></div></div>
    </main>
    
    <script id="data-island" type="application/json"><!--__JSON_DATA_PLACEHOLDER__--></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        try {
            const chartDataText = document.getElementById('data-island').textContent;
            if (!chartDataText || chartDataText.includes('__JSON_DATA_PLACEHOLDER__')) {
                console.error("A 'ilha de dados' (data island) não contém um JSON válido.");
                return;
            }
            
            const chartData = JSON.parse(chartDataText);
            const noDataMessage = '<div class="no-data-message">Sem dados para exibir nesta categoria.</div>';
            const cores = chartData.cores; // Pega o dicionário de cores injetado
            
            // --- Treemaps (Plotly) ---
            if (chartData.treemap_exclusivo && chartData.treemap_exclusivo.labels?.length > 0) {
                Plotly.newPlot('treemapExclusivo', [{ type: 'treemap', labels: chartData.treemap_exclusivo.labels, parents: chartData.treemap_exclusivo.parents, values: chartData.treemap_exclusivo.values, customdata: chartData.treemap_exclusivo.projetos, hovertemplate: '<b>%{label}</b><br>Valor: %{value:,.2f}<br>Projetos:<br>%{customdata}<extra></extra>', textinfo: 'label+value+percent root', marker: { colorscale: 'Blues', reversescale: true } }], { margin: { t: 10, l: 10, r: 10, b: 10 }, font: { family: 'Roboto' } }, { responsive: true, displayModeBar: false });
            } else { document.getElementById('treemapExclusivo').innerHTML = noDataMessage; }
            if (chartData.treemap_compartilhado && chartData.treemap_compartilhado.labels?.length > 0) {
                Plotly.newPlot('treemapCompartilhado', [{ type: 'treemap', labels: chartData.treemap_compartilhado.labels, parents: chartData.treemap_compartilhado.parents, values: chartData.treemap_compartilhado.values, customdata: chartData.treemap_compartilhado.projetos, hovertemplate: '<b>%{label}</b><br>Valor: %{value:,.2f}<br>Projetos:<br>%{customdata}<extra></extra>', textinfo: 'label+value+percent root', marker: { colorscale: 'Greens', reversescale: true } }], { margin: { t: 10, l: 10, r: 10, b: 10 }, font: { family: 'Roboto' } }, { responsive: true, displayModeBar: false });
            } else { document.getElementById('treemapCompartilhado').innerHTML = noDataMessage; }

            // --- Gráfico de Tendência (Chart.js) ---
            new Chart(document.getElementById('trendChart').getContext('2d'), { type: 'line', data: chartData.trend, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { callback: v => (v >= 1e6 ? `${(v/1e6).toFixed(1)}M` : `${(v/1e3).toFixed(0)}k`) } }, x: { grid: { display: false } } } } });
            
            // --- Orçamento Ocioso (Chart.js) ---
            const idleBudgetData = chartData.idle_budget;
            if (idleBudgetData && idleBudgetData.labels?.length > 0) {
                new Chart(document.getElementById('idleBudgetChart').getContext('2d'), {
                    type: 'bar',
                    data: { labels: idleBudgetData.labels, datasets: [ 
                        { label: 'Exclusivos', data: idleBudgetData.values_exclusivo, backgroundColor: cores.project_exclusive, meta: idleBudgetData.detalhes_exclusivo }, 
                        { label: 'Compartilhados', data: idleBudgetData.values_compartilhado, backgroundColor: cores.project_shared, meta: idleBudgetData.detalhes_compartilhado } 
                    ] },
                    options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' }, tooltip: { callbacks: { footer: items => (items[0].dataset.meta?.[items[0].dataIndex] || []).length > 0 ? ['Principais Ações:'].concat(items[0].dataset.meta[items[0].dataIndex]) : '' } } }, 
                        scales: { x: { stacked: true, ticks: { callback: v => (v >= 1e6 ? `${(v/1e6).toFixed(1)}M` : `${(v/1e3).toFixed(0)}k`) } }, y: { stacked: true } }
                    }
                });
            } else { document.getElementById('idleBudgetContainer').innerHTML = noDataMessage; }

            // --- Execução Sem Planejamento (Exclusivos) ---
            const unplannedExclusivoData = chartData.unplanned_exclusivo;
            if (unplannedExclusivoData && unplannedExclusivoData.labels?.length > 0) {
                new Chart(document.getElementById('unplannedExclusivoChart').getContext('2d'), {
                    type: 'bar',
                    data: { labels: unplannedExclusivoData.labels, datasets: [{ label: 'Executado Sem Orçamento', data: unplannedExclusivoData.values, backgroundColor: unplannedExclusivoData.color, meta: unplannedExclusivoData.projetos }] },
                    options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { footer: items => (items[0].dataset.meta?.[items[0].dataIndex] || []).length > 0 ? ['Principais Projetos:'].concat(items[0].dataset.meta[items[0].dataIndex]) : '' } } }, scales: { x: { ticks: { callback: v => (v >= 1e6 ? `${(v/1e6).toFixed(1)}M` : `${(v/1e3).toFixed(0)}k`) } } } }
                });
            } else { document.getElementById('unplannedExclusivoContainer').innerHTML = noDataMessage; }

            // --- Execução Sem Planejamento (Compartilhados) ---
            const unplannedCompartilhadoData = chartData.unplanned_compartilhado;
            if (unplannedCompartilhadoData && unplannedCompartilhadoData.labels?.length > 0) {
                 new Chart(document.getElementById('unplannedCompartilhadoChart').getContext('2d'), {
                    type: 'bar',
                    data: { labels: unplannedCompartilhadoData.labels, datasets: [{ label: 'Executado Sem Orçamento', data: unplannedCompartilhadoData.values, backgroundColor: unplannedCompartilhadoData.color, meta: unplannedCompartilhadoData.projetos }] },
                    options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { footer: items => (items[0].dataset.meta?.[items[0].dataIndex] || []).length > 0 ? ['Principais Projetos:'].concat(items[0].dataset.meta[items[0].dataIndex]) : '' } } }, scales: { x: { ticks: { callback: v => (v >= 1e6 ? `${(v/1e6).toFixed(1)}M` : `${(v/1e3).toFixed(0)}k`) } } } }
                });
            } else { document.getElementById('unplannedCompartilhadoContainer').innerHTML = noDataMessage; }
        } catch (error) {
            console.error("Ocorreu um erro ao renderizar os gráficos:", error);
        }
    });
    </script>
</body>
</html>
